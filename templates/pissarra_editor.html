<!doctype html>
<html lang="{{ lang or 'ca' }}">

<head>
    <meta charset="utf-8">
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-pencil' viewBox='0 0 16 16'%3E%3Cpath d='M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z'/%3E%3C/svg%3E">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Editor - {{ board.title }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            font-family: sans-serif;
        }

        .toolbar {
            background: #2c3e50;
            color: white;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .pissarra-canvas-wrapper {
            flex: 1;
            background: #ecf0f1;
            overflow: auto;
            display: block;
            /* Canviat de flex per evitar problemes de coordenades en Firefox/Safari */
            padding: 50px;
            text-align: center;
        }

        #canvasGroup {
            position: relative;
            display: inline-block;
            /* Perquè s'ajusti al contingut i es centri amb text-align */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: white;
            /* Fons blanc base */
        }

        .canvas-container {
            margin: 0 !important;
            z-index: 1;
            /* Per sobre de la graella */
        }

        canvas {
            border: 1px solid #bdc3c7;
            /* background: white;  EI: Fons transparent perquè es vegi la graella de sota */
            touch-action: none;
        }

        /* Crucial: evitar que la capa d'interacció de Fabric.js tapi el dibuix */
        .upper-canvas {
            background-color: transparent !important;
            z-index: 10;
        }

        .lower-canvas {
            z-index: 1;
        }

        .tool-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn.active {
            background: #3498db;
            transform: scale(1.05);
        }

        .tool-btn:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .tool-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            color: #bdc3c7;
        }

        input[type="color"] {
            border: none;
            width: 34px;
            height: 34px;
            cursor: pointer;
            background: none;
            padding: 0;
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* Deixa passar els clics al canvas */
            display: none;
            background-image: linear-gradient(#ddd 1px, transparent 1px), linear-gradient(90deg, #ddd 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
            /* Al fons de tot, sobre el div blanc però sota el canvas */
        }

        .save-btn {
            background: #27ae60 !important;
        }

        .save-btn:hover {
            background: #2ecc71 !important;
            color: white !important;
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <a href="{{ url_for('recursos.pissarra_list') }}" class="tool-btn" title="Enrere"><i
                class="bi bi-chevron-left"></i></a>
        <div style="display:flex; gap:2px;">
            <button class="tool-btn" id="undoBtn" onclick="undo()" title="Desfer (Ctrl+Z)" disabled {% if not can_edit
                %}style="display:none;" {% endif %}><i class="bi bi-arrow-counterclockwise"></i></button>
            <button class="tool-btn" id="redoBtn" onclick="redo()" title="Refer (Ctrl+Y)" disabled {% if not can_edit
                %}style="display:none;" {% endif %}><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <span style="font-weight:bold; margin-right:15px; font-size: 1.1rem; margin-left: 10px;">{{ board.title
            }}</span>

        <div style="height: 30px; width: 1px; background: #555; margin: 0 5px;"></div>

        {% if can_edit %}
        <div style="display:flex; gap:5px;">
            <button class="tool-btn" id="selectBtn" onclick="setTool('select')" title="Seleccionar"><i
                    class="bi bi-cursor"></i></button>
            <button class="tool-btn active" id="pencilBtn" onclick="setTool('pencil')" title="Llapis"><i
                    class="bi bi-pencil"></i></button>
            <button class="tool-btn" id="eraserBtn" onclick="setTool('eraser')" title="Goma"><i
                    class="bi bi-eraser"></i></button>
            <button class="tool-btn" id="textBtn" onclick="addText()" title="Text"><i class="bi bi-type"></i></button>
            <button class="tool-btn" id="lineBtn" onclick="setTool('line')" title="Línia"><i
                    class="bi bi-slash-lg"></i></button>
            <button class="tool-btn" id="rectBtn" onclick="setTool('rect')" title="Rectangle"><i
                    class="bi bi-square"></i></button>
            <button class="tool-btn" id="circleBtn" onclick="setTool('circle')" title="Cercle"><i
                    class="bi bi-circle"></i></button>
        </div>
        {% endif %}

        <div style="height: 30px; width: 1px; background: #555; margin: 0 5px;"></div>

        {% if can_edit %}
        <div style="display:flex; align-items:center; gap:8px;">
            <input type="color" id="colorPicker" value="#000000" oninput="updateBrush()" title="Color">
            <input type="range" id="widthPicker" min="1" max="50" value="3" oninput="updateBrush()" style="width:100px;"
                title="Gruix">
            <div style="display:flex; flex-direction:column; align-items:center; margin-left:5px;">
                <span style="color:white; font-size:10px;">Opacitat</span>
                <input type="range" id="opacityPicker" min="1" max="100" value="100" oninput="updateBrush()"
                    style="width:100px;" title="Opacitat">
            </div>
        </div>
        {% endif %}

        <div style="height: 30px; width: 1px; background: #555; margin: 0 5px;"></div>

        {% if can_edit %}
        <div style="display:flex; gap:5px;">
            <button class="tool-btn" onclick="document.getElementById('imgInput').click()" title="Afegir Imatge"><i
                    class="bi bi-image"></i></button>
            <input type="file" id="imgInput" style="display:none;" accept="image/*" onchange="addImage(event)">
            <button class="tool-btn" id="gridBtn" onclick="toggleGrid()" title="Quadrícula"><i
                    class="bi bi-grid-3x3"></i></button>
            <button class="tool-btn" onclick="deleteSelected()" title="Esborrar seleccionats"><i
                    class="bi bi-trash"></i></button>
            {% if is_owner %}
            <button class="tool-btn" onclick="clearCanvas()" title="Netejar-ho tot" style="color:#e74c3c;"><i
                    class="bi bi-x-circle"></i></button>
            {% endif %}
        </div>
        {% else %}
        <div style="display:flex; gap:5px;">
            <button class="tool-btn" id="gridBtn" onclick="toggleGrid()" title="Quadrícula"><i
                    class="bi bi-grid-3x3"></i></button>
        </div>
        {% endif %}

        {% if can_edit %}
        <button class="tool-btn save-btn" style="margin-left:auto; font-weight: bold;" onclick="saveBoard()"><i
                class="bi bi-save" style="margin-right:5px;"></i> {{ content.recursos.btn_save if content and
            content.recursos is defined else "Guardar" }}</button>
        {% endif %}
    </div>

    {% if not can_edit %}
    <div class="w3-panel w3-pale-blue w3-border w3-border-blue" style="margin: 0; border-radius: 0;">
        <p class="w3-center" style="margin: 8px 0;"><i class="bi bi-info-circle"></i> Estàs veient aquesta pissarra en
            mode només lectura. <a href="{{ url_for('recursos.recursos_login') }}" class="w3-text-blue"><b>Inicia
                    sessió</b></a> per poder editar-la.</p>
    </div>
    {% endif %}

    <div class="pissarra-canvas-wrapper" id="canvasWrap">
        <div id="canvasGroup">
            <div class="grid-overlay" id="grid"></div>
            <canvas id="c" width="3600" height="2400"></canvas>
        </div>
    </div>

    {# Contenidor segur per a les dades JSON #}
    <script id="board-data" type="application/json">{{ canvas_data | safe }}</script>

    <script>
        const canvas = new fabric.Canvas('c', {
            isDrawingMode: {{ 'true' if can_edit else 'false' }},
        width: 3600,
            height: 2400,
                backgroundColor: null, // Transparent perquè es vegi el div blanc o la graella de sota
                    preserveObjectStacking: true,
                        selection: {{ 'true' if can_edit else 'false' }}
        });

        // --- GESTIÓ DE L'HISTORIAL (Undo/Redo) ---
        let history = [];
        let historyStep = -1;
        let isHistoryLocked = false; // Per evitar bucles infinits quan carreguem un estat

        function saveHistory() {
            if (isHistoryLocked) return;

            // Si estem al mig de l'historial (hem fet undo), esborrem el futur
            if (historyStep < history.length - 1) {
                history = history.slice(0, historyStep + 1);
            }

            // Guardem l'estat actual
            const json = JSON.stringify(canvas.toJSON());
            history.push(json);
            historyStep++;

            // Límit de memòria
            if (history.length > 30) {
                history.shift();
                historyStep--;
            }

            updateHistoryButtons();
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                isHistoryLocked = true;
                const state = JSON.parse(history[historyStep]);
                state.background = null;
                canvas.loadFromJSON(state, function () {
                    canvas.renderAll();
                    isHistoryLocked = false;

                    if (currentTool === 'eraser') {
                        canvas.add(eraserCursor);
                        updateBrush();
                    }
                    updateHistoryButtons();
                });
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                historyStep++;
                isHistoryLocked = true;
                const state = JSON.parse(history[historyStep]);
                state.background = null;
                canvas.loadFromJSON(state, function () {
                    canvas.renderAll();
                    isHistoryLocked = false;

                    if (currentTool === 'eraser') {
                        canvas.add(eraserCursor);
                        updateBrush();
                    }
                    updateHistoryButtons();
                });
            }
        }

        function updateHistoryButtons() {
            document.getElementById('undoBtn').disabled = (historyStep <= 0);
            document.getElementById('redoBtn').disabled = (historyStep >= history.length - 1);
        }

        // Escoltem canvis per guardar l'historial
        canvas.on('object:added', function (e) {
            // Ignorem objectes com el cursor de la goma
            if (e.target && e.target.excludeFromExport) return;
            saveHistory();
        });
        canvas.on('object:modified', saveHistory);
        canvas.on('object:removed', function (e) {
            if (e.target && e.target.excludeFromExport) return;
            saveHistory();
        });

        // Configura la goma correctament (de veritat, no només pintar de blanc)
        // Per a Fabric.js 5+ podem fer servir EraseBrush si volem, però el Pencil blanc és un fallback clàssic.
        // Tanmateix, Fabric.js 5 té fabric.EraserBrush si s'inclou el mòdul, però la versió CDN estàndard potser no.
        // Triem el mètode de pintar de blanc per simplicitat en aquesta versió sense dependències extra.

        // Carregar dades inicials de forma segura
        try {
            const boardContent = document.getElementById('board-data').textContent;
            let loaded = false;

            const onLoaded = function () {
                canvas.renderAll();
                canvas.calcOffset();
                // Ens assegurem que el zoom i la posició són correctes
                canvas.setZoom(1);
                canvas.viewportTransform = [1, 0, 0, 1, 0, 0];
                setTimeout(() => { canvas.renderAll(); canvas.calcOffset(); }, 100);
                setTimeout(() => { canvas.renderAll(); }, 500);

                // Inicialitzem historial amb l'estat inicial
                saveHistory();

                {% if not can_edit %}
                // Disable selection and editing for all objects
                canvas.forEachObject(function (obj) {
                    obj.selectable = false;
                    obj.evented = false;
                });
                {% endif %}
            };

            if (boardContent && boardContent.trim() !== "" && boardContent.length > 30) {
                const boardData = JSON.parse(boardContent);
                boardData.background = null;
                isHistoryLocked = true;
                canvas.loadFromJSON(boardData, function () {
                    isHistoryLocked = false;
                    onLoaded();
                });
                loaded = true;
            }

            if (!loaded) {
                canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
                canvas.renderAll();
                onLoaded();
            }
        } catch (e) {
            console.error("Error carregant dades de la pissarra:", e);
            canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
            saveHistory();
        }

        let currentTool = 'pencil';
        let isDrawingShape = false;
        let shape, origX, origY;

        // Cursor visual per la goma
        const eraserCursor = new fabric.Circle({
            radius: 10,
            fill: 'transparent',
            stroke: 'black',
            strokeWidth: 1,
            strokeDashArray: [5, 5],
            selectable: false,
            evented: false,
            originX: 'center',
            originY: 'center',
            excludeFromExport: true
        });

        // Helper per convertir hex a rgba
        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function updateBrush() {
            const width = parseInt(document.getElementById('widthPicker').value);

            if (currentTool === 'eraser') {
                eraserCursor.set({ radius: width * 2 });
                canvas.requestRenderAll();
            } else if (canvas.isDrawingMode && canvas.freeDrawingBrush) {
                const rawColor = document.getElementById('colorPicker').value;
                const opacityVal = parseInt(document.getElementById('opacityPicker').value) / 100;
                canvas.freeDrawingBrush.color = hexToRgba(rawColor, opacityVal);
                canvas.freeDrawingBrush.width = width;
            }
        }

        function setTool(tool) {
            currentTool = tool;
            // Desactiva dibuix si estem en selecció, formes o goma intel·ligent
            canvas.isDrawingMode = (tool === 'pencil');

            // Gestió del cursor de la goma
            if (tool === 'eraser') {
                canvas.add(eraserCursor);
                canvas.defaultCursor = 'none'; // Amaga el punter del ratolí
                canvas.hoverCursor = 'none';
                updateBrush(); // Per assegurar que té el radi correcte
            } else {
                canvas.remove(eraserCursor);
                canvas.defaultCursor = 'default';
                canvas.hoverCursor = 'move';
            }

            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(tool + 'Btn');
            if (btn) btn.classList.add('active');

            if (canvas.isDrawingMode) {
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                updateBrush();
            } else {
                canvas.selection = (tool === 'select');
                if (tool !== 'select') canvas.selection = false;

                // Configurem selectabilitat segons l'eina
                canvas.getObjects().forEach(obj => {
                    obj.selectable = (tool === 'select');
                    // Bloquem interacció amb objectes si estem en mode goma per evitar seleccions accidentals
                    obj.evented = (tool !== 'eraser');
                });
            }
            canvas.requestRenderAll();
        }

        {% if can_edit %}
        canvas.on('mouse:down', function (o) {
            if (canvas.isDrawingMode || currentTool === 'select') return;
            isDrawingShape = true;
            let pointer = canvas.getPointer(o.e);
            origX = pointer.x;
            origY = pointer.y;

            const rawColor = document.getElementById('colorPicker').value;
            const opacityVal = parseInt(document.getElementById('opacityPicker').value) / 100;
            const color = hexToRgba(rawColor, opacityVal);
            const width = parseInt(document.getElementById('widthPicker').value);

            if (currentTool === 'line') {
                shape = new fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], {
                    strokeWidth: width,
                    stroke: color,
                    originX: 'center',
                    originY: 'center',
                    selectable: true
                });
            } else if (currentTool === 'rect') {
                shape = new fabric.Rect({
                    left: origX,
                    top: origY,
                    width: 0,
                    height: 0,
                    fill: 'transparent',
                    stroke: color,
                    strokeWidth: width,
                    selectable: true
                });
            } else if (currentTool === 'circle') {
                shape = new fabric.Circle({
                    left: origX,
                    top: origY,
                    radius: 0,
                    fill: 'transparent',
                    stroke: color,
                    strokeWidth: width,
                    selectable: true
                });
            }
            if (shape) canvas.add(shape);
        });

        canvas.on('mouse:move', function (o) {
            if (currentTool === 'eraser') {
                const pointer = canvas.getPointer(o.e);
                eraserCursor.set({ left: pointer.x, top: pointer.y });
                eraserCursor.setCoords(); // Important per detectar interseccions correctament

                if (o.e.buttons === 1) {
                    // Esborrat per àrea (intersecció amb el cursor)
                    const objects = canvas.getObjects();
                    let removedSomething = false;
                    objects.forEach(obj => {
                        if (obj === eraserCursor) return;
                        if (obj.type === 'image') return; // No esborrem imatges (segons lògica anterior)

                        // Mirem si l'objecte intersecta amb el cercle de la goma
                        if (eraserCursor.intersectsWithObject(obj) || obj.intersectsWithObject(eraserCursor)) {
                            canvas.remove(obj);
                            removedSomething = true;
                        }
                    });
                    if (removedSomething) {
                        saveHistory(); // Guardem historial si hem esborrat alguna cosa
                    }
                }
                canvas.renderAll();
                return;
            }

            if (!isDrawingShape) return;
            let pointer = canvas.getPointer(o.e);

            if (currentTool === 'line') {
                shape.set({ x2: pointer.x, y2: pointer.y });
            } else if (currentTool === 'rect') {
                shape.set({
                    left: Math.min(origX, pointer.x),
                    top: Math.min(origY, pointer.y),
                    width: Math.abs(origX - pointer.x),
                    height: Math.abs(origY - pointer.y)
                });
            } else if (currentTool === 'circle') {
                let radius = Math.sqrt(Math.pow(origX - pointer.x, 2) + Math.pow(origY - pointer.y, 2)) / 2;
                shape.set({
                    left: Math.min(origX, pointer.x),
                    top: Math.min(origY, pointer.y),
                    radius: radius
                });
            }
            canvas.renderAll();
        });

        canvas.on('mouse:up', function () {
            if (isDrawingShape) {
                isDrawingShape = false;
                // La forma s'ha acabat de dibuixar, guardem historial
                saveHistory();
            }
        });
        {% endif %}

        {% if can_edit %}

        function addText() {
            const rawColor = document.getElementById('colorPicker').value;
            const opacityVal = parseInt(document.getElementById('opacityPicker').value) / 100;
            const color = hexToRgba(rawColor, opacityVal);

            const text = new fabric.IText('Text...', {
                left: 100,
                top: 100,
                fill: color,
                fontSize: 24,
                fontFamily: 'Arial'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            setTool('select');
        }

        function addImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (f) {
                fabric.Image.fromURL(f.target.result, function (img) {
                    img.scaleToWidth(400);
                    canvas.add(img);
                    canvas.centerObject(img);
                    canvas.setActiveObject(img);
                    // Historial automàticament gràcies a 'object:added'
                });
            };
            reader.readAsDataURL(file);
        }

        function toggleGrid() {
            const grid = document.getElementById('grid');
            const isActive = grid.style.display === 'block';
            grid.style.display = isActive ? 'none' : 'block';
            document.getElementById('gridBtn').classList.toggle('active', !isActive);
        }

        function deleteSelected() {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length > 0) {
                activeObjects.forEach(obj => canvas.remove(obj));
                canvas.discardActiveObject();
                canvas.renderAll();
                // Historial automàticament gràcies a 'object:removed'
            }
        }

        window.addEventListener('keydown', function (e) {
            // Undo: Ctrl+Z
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            // Redo: Ctrl+Y or Ctrl+Shift+Z
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) {
                e.preventDefault();
                redo();
            }

            if (e.key === 'Delete' || e.key === 'Backspace') {
                // Només si no estem editant un text
                const active = canvas.getActiveObject();
                if (active && active.type === 'i-text' && active.isEditing) return;
                deleteSelected();
            }
        });

        function clearCanvas() {
            if (confirm('Vols esborrar tota la pissarra?')) {
                canvas.clear();
                canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
                saveHistory();
            }
        }
        {% endif %}

        function saveBoard() {
            const jsonData = canvas.toJSON();
            fetch("{{ url_for('recursos.pissarra_guardar', board_id=board.id) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(jsonData)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // Notificació visual subtil en comptes de alert si és possible
                        const btn = document.querySelector('.save-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check-lg"></i> Guardat!';
                        setTimeout(() => { btn.innerHTML = originalText; }, 2000);
                    }
                })
                .catch(err => {
                    console.error("Error guardant:", err);
                    alert("Error al guardar.");
                });
        }

        // Inicialització final
        window.addEventListener('resize', () => canvas.calcOffset());
        setTimeout(() => {
            canvas.calcOffset();
            canvas.renderAll();
            if (currentTool === 'pencil') setTool('pencil');
        }, 300);
    </script>
    <script> const pagina_nom = "pissarres"; </script>
    <script src="/static/js/registre_clics.js"></script>
</body>

</html>